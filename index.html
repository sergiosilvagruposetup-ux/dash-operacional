<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Operacional Avan√ßado | S√©rgio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .card { background: white; border-radius: 1.25rem; padding: 1.5rem; border: 1px solid #e2e8f0; }
        .filter-group { background: white; padding: 1rem; border-radius: 1rem; border: 1px solid #e2e8f0; display: flex; gap: 1.5rem; flex-wrap: wrap; }
        select { border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.875rem; outline: none; min-width: 150px; }
    </style>
</head>
<body class="p-4 lg:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Estratifica√ß√£o Operacional</h1>
            
            <div class="filter-group shadow-sm mt-6">
                <div class="flex flex-col">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Centro de Servi√ßo</label>
                    <select id="select-centro" onchange="processData()"></select>
                </div>
                <div class="flex flex-col">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Ano</label>
                    <select id="select-ano" onchange="processData()"></select>
                </div>
                <div class="flex flex-col">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">M√™s</label>
                    <select id="select-mes" onchange="processData()">
                        <option value="Todos">Todos os Meses</option>
                        <option value="01">Janeiro</option><option value="02">Fevereiro</option>
                        <option value="03">Mar√ßo</option><option value="04">Abril</option>
                        <option value="05">Maio</option><option value="06">Junho</option>
                        <option value="07">Julho</option><option value="08">Agosto</option>
                        <option value="09">Setembro</option><option value="10">Outubro</option>
                        <option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="ml-auto self-end pb-1">
                    <span id="sync-tag" class="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full uppercase">Sincronizado</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card border-l-4 border-slate-300 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Testes Totais</p>
                <h2 id="kpi-total" class="text-3xl font-bold text-slate-800">---</h2>
            </div>
            <div class="card border-l-4 border-blue-500 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Benchmark</p>
                <h2 id="kpi-bench" class="text-xl font-bold text-blue-600">---</h2>
            </div>
            <div class="card border-l-4 border-emerald-500 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Assertividade</p>
                <h2 id="kpi-assert" class="text-3xl font-bold text-emerald-600">---</h2>
            </div>
            <div class="card border-l-4 border-rose-500 text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Reprovados</p>
                <h2 id="kpi-reprov" class="text-3xl font-bold text-rose-600">---</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="card h-fit">
                <h3 class="text-lg font-bold text-slate-800 mb-6">üì¶ Itens Cr√≠ticos</h3>
                <div id="item-list" class="space-y-5"></div>
            </div>
            <div class="lg:col-span-2 card">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Tend√™ncia de Aprova√ß√£o (%)</h3>
                <div id="main-chart"></div>
            </div>
        </div>
    </div>

    <script>
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXamYvh04HKUMqADox30UrRg1db4psyOnx3kUt8x1TbTqtbRFGe-_e1B4vVRe-eoW-KMSyFud7OGKm/pub?output=csv";
        let rawData = [];
        let chart;

        async function init() {
            const resp = await fetch(csvUrl);
            const text = await resp.text();
            // Transformar CSV em Array de Objetos
            const rows = text.split('\n').map(r => r.split(','));
            const headers = rows[0].map(h => h.trim().replace(/"/g, ''));
            
            rawData = rows.slice(1).map(r => {
                let obj = {};
                r.forEach((cell, i) => {
                    obj[headers[i]] = cell.trim().replace(/"/g, '');
                });
                return obj;
            });

            populateFilters();
            processData();
        }

        function populateFilters() {
            // Pegar Centros √önicos (Coluna 'Centro de Servi√ßo' ou similar)
            const centros = [...new Set(rawData.map(d => d['Centro de Servi√ßo'] || d['Centro']))].filter(Boolean);
            const anos = [...new Set(rawData.map(d => d['Ano']))].filter(Boolean).sort();

            const cSelect = document.getElementById('select-centro');
            cSelect.innerHTML = '<option value="Todos">Todos os Centros</option>' + 
                                centros.map(c => `<option value="${c}">${c}</option>`).join('');

            const aSelect = document.getElementById('select-ano');
            aSelect.innerHTML = '<option value="Todos">Todos os Anos</option>' + 
                                anos.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function processData() {
            const fCentro = document.getElementById('select-centro').value;
            const fAno = document.getElementById('select-ano').value;
            const fMes = document.getElementById('select-mes').value;

            // Filtragem L√≥gica
            const filtered = rawData.filter(d => {
                return (fCentro === 'Todos' || (d['Centro de Servi√ßo'] || d['Centro']) === fCentro) &&
                       (fAno === 'Todos' || d['Ano'] === fAno) &&
                       (fMes === 'Todos' || d['M√™s'] === fMes);
            });

            updateUI(filtered);
        }

        function updateUI(data) {
            // C√°lculo de KPIs baseados nos filtros
            const total = data.reduce((acc, curr) => acc + (Number(curr['Total']) || 0), 0);
            const reprov = data.reduce((acc, curr) => acc + (Number(curr['Reprovados']) || 0), 0);
            const assert = total > 0 ? ((1 - (reprov / total)) * 100).toFixed(2) : "0.00";

            document.getElementById('kpi-total').innerText = total > 1000 ? (total/1000).toFixed(1) + 'K' : total;
            document.getElementById('kpi-bench').innerText = "NA"; 
            document.getElementById('kpi-assert').innerText = assert + '%';
            document.getElementById('kpi-reprov').innerText = reprov;

            renderChart(data);
            renderItemList(data);
        }

        function renderItemList(data) {
            // Agrupar por item e somar reprova√ß√µes
            const itemsMap = {};
            data.forEach(d => {
                const name = d['Item'] || 'Desconhecido';
                itemsMap[name] = (itemsMap[name] || 0) + (Number(d['Reprovados']) || 0);
            });

            const sortedItems = Object.entries(itemsMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const max = sortedItems[0] ? sortedItems[0][1] : 1;

            document.getElementById('item-list').innerHTML = sortedItems.map(([name, val]) => `
                <div>
                    <div class="flex justify-between text-xs font-bold mb-1 uppercase text-slate-600">
                        <span>${name}</span><span>${val}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full" style="width: ${(val/max)*100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderChart(data) {
            // Agrupar por M√™s para o gr√°fico
            const mesesLabels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const valores = new Array(12).fill(0);
            const contagem = new Array(12).fill(0);

            data.forEach(d => {
                const mIdx = parseInt(d['M√™s']) - 1;
                if(mIdx >= 0 && mIdx < 12) {
                    const total = Number(d['Total']) || 0;
                    const reprov = Number(d['Reprovados']) || 0;
                    const taxa = total > 0 ? (1 - (reprov/total)) * 100 : 0;
                    valores[mIdx] += taxa;
                    contagem[mIdx]++;
                }
            });

            const serieData = valores.map((v, i) => contagem[i] > 0 ? (v / contagem[i]).toFixed(2) : null);

            const options = {
                series: [{ name: 'Aprova√ß√£o', data: serieData }],
                chart: { height: 350, type: 'area', toolbar: { show: false } },
                colors: ['#10b981'],
                stroke: { curve: 'smooth', width: 3 },
                xaxis: { categories: mesesLabels },
                yaxis: { min: 90, max: 100, labels: { formatter: v => v + '%' } },
                fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.1 } }
            };

            if(chart) chart.destroy();
            chart = new ApexCharts(document.querySelector("#main-chart"), options);
            chart.render();
        }

        init();
    </script>
</body>
</html>
